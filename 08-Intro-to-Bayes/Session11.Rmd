
## 設計一個交互作用模型

From Page 241 of the [rethinking book](https://xcelab.net/rm/statistical-rethinking/): 

> We could cheat by splitting the data into two data frames. But it's not a good idea to split the data in this way. Here are four reasons. 

> First, there are usually some parameters, such as $\sigma$, that the model says do not depend in any way upon continent (the variable you want to split the data on). By splitting the data table, you are hurting the accuracy of the estimates of pooling all of the eivdence into one estimate. In effect, you have accidentally assumed that variance differs between African and non-African nations. Now, there is nothing wrong with that sort of assumption. But you want to avoid accidental assumptions. 

> Second ... 

> Third, we may want to use information criteria or another method to compare models. In order to compare a model that treats all continents the same way to a model that allows different slopes in different continents, we need models that use all of the same data. This means that we cannot split the data for two separate models. We have to let a single model internally split the data. 

> Fourth, once you begin using multilevel models, you'll see that there are advantages to borrowing information across categories like "Africa" and "not Africa." This is especially true when sample sizes vary across categories, such that overfitting risk is higher within some categories. In other words, what we learn about ruggedness outside of Africa should have some effect on our estimate within Africa, and vise versa. Mulitlevel models borrow information in this way, in order to improve estimates in all categories. When we split the data, this borrowing is impossible. 

### 設計非洲大陸地形的模型 

我們先設計一個不包含是否是非洲大陸這一變量的模型。

```{r introBayes11-01, cache=TRUE}
data("rugged")
d <- rugged

# make log version of outcome
d$log_gdp <- log( d$rgdppc_2000 )

# extract countries with GDP data
dd <- d[ complete.cases( d$rgdppc_2000 ), ]

# rescale variables
dd$log_gdp_std <- dd$log_gdp / mean( dd$log_gdp )
dd$rugged_std <- dd$rugged / max( dd$rugged )

```

使用簡單線性回歸來分析土地的崎嶇程度和該地區的生產總值之間可能存在的關係：

$$
\begin{aligned}
\log (y_i) & \sim \text{Normal}(\mu_i, \sigma) \\
\mu_i &  =  \alpha + \beta(r_i - \bar{r})
\end{aligned}
$$

其中，

- $y_i$ 是第 $i$ 地區的GDP；
- $r_i$ 是第 $i$ 地區的崎嶇程度；
- $\bar{r}$ 是全體地區崎嶇程度的平均值，大約是 0.215。

我們現在對與這兩者之間的關係並不瞭解，只能猜測，並賦予先驗概率分佈進行估算：

$$
\begin{aligned}
\alpha & \sim \text{Normal}(1,1) \\
\beta & \sim \text{Normal}(0, 1) \\
\sigma & \sim \exp(1)
\end{aligned}
$$

把這些翻譯成R語言模型：


```{r introBayes11-02, cache=TRUE}
m8.1 <- quap(
  alist(
    log_gdp_std ~ dnorm( mu, sigma ), 
    mu <- a + b * (rugged_std - 0.215), 
    a ~ dnorm( 1, 1 ), 
    b ~ dnorm( 0, 1 ), 
    sigma ~ dexp(1)
  ), data = dd
)
```


讓我們先來審視一下我們選擇的先驗概率大致是什麼樣的：


```{r introBayes11-fig01, cache=TRUE, fig.width=6, fig.height=5,  fig.cap="Simulating in search of reasonable priors for the terrain ruggedness example. The dashed horizontal lines indicate the minimum and maximum observed GDP values. The first guess with very vague priors.", fig.align='center'}
set.seed(7)
prior <- extract.prior( m8.1 )

# set up the plot dimensions

plot(NULL, xlim = c(0, 1), ylim = c(0.5, 1.4), 
     xlab = "ruggedness", ylab = "log GDP", 
     bty = "n", 
     main = "a ~ dnorm(1,1)\nb ~ dnorm(0,1)")
abline(h = min(dd$log_gdp_std), lty = 2)
abline(h = max(dd$log_gdp_std), lty = 2)
with(dd, abline(a = 1.28, b = -0.6, 
       lty = 1, lwd = 1.5, col = c("blue")))

# draw 50 lines from the prior
rugged_seq <- seq(from = -0.1, to = 1.1, length.out = 30)
mu <- link( m8.1, post = prior, data = data.frame(rugged_std = rugged_seq))
for( i in 1:50 ) lines( rugged_seq, mu[i,], col = col.alpha("black", 0.3))
```


圖 \@ref(fig:introBayes11-fig01) 中的上下兩條水平虛線分別是對數GDP的最大值和最小值。可以看見，我們這裏選擇使用的斜率和截距的先驗概率分佈是五花八門的，有正有負，有大有小，包含了很多令人匪夷所思的斜率或者截距。很顯然，我們最好對這些過於寬泛的斜率截距的選擇加以合理的限制以提高效率。例如選擇一個均值爲0，標準差是 0.1 的正（常）態分佈作爲截距 $\alpha$ 的先驗概率分佈可能會比較合理。因爲 $\text{Normal}(0, 0.1)$ 其實包含的意思是「我們認爲有95%的可能性截距是在 0.8-1.2之間」。同時，該圖 \@ref(fig:introBayes11-fig01) 所示的斜率太過分散，有很多甚至比觀察數據給出的最大斜率 1.3 - 0.7 = 0.6 (藍色的線) 更加極端的斜率。在這裏使用的先驗概率中 $\beta \sim \text{Normal}(0,1)$ ，有超過一半以上的斜率其實是要大於0.6的：

```{r introBayes11-03, cache=TRUE}
sum( abs(prior$b) > 0.6 ) /length(prior$b)
```

如果把斜率的先驗概率調整爲 $\beta \sim \text{Normal}(0, 0.3)$ 的話，就能把斜率大於0.6的可能性降低到兩個標準差之外。



```{r introBayes11-fig02, cache=TRUE, fig.width=6, fig.height=5,  fig.cap="Simulating in search of reasonable priors for the terrain ruggedness example. The dashed horizontal lines indicate the minimum and maximum observed GDP values. The improved model with much more plausible priors.", fig.align='center'}
m8.1 <- quap(
  alist(
    log_gdp_std ~ dnorm( mu, sigma ), 
    mu <- a + b * (rugged_std - 0.215), 
    a ~ dnorm( 1, 0.1 ), 
    b ~ dnorm( 0, 0.3 ), 
    sigma ~ dexp(1)
  ), data = dd
)
set.seed(7)
prior <- extract.prior( m8.1 )

# set up the plot dimensions

plot(NULL, xlim = c(0, 1), ylim = c(0.5, 1.4), 
     xlab = "ruggedness", ylab = "log GDP", 
     bty = "n", 
     main = "a ~ dnorm(1,1)\nb ~ dnorm(0,1)")
abline(h = min(dd$log_gdp_std), lty = 2)
abline(h = max(dd$log_gdp_std), lty = 2)
with(dd, abline(a = 1.28, b = -0.6, 
       lty = 1, lwd = 1.5, col = c("blue")))

# draw 50 lines from the prior
rugged_seq <- seq(from = -0.1, to = 1.1, length.out = 30)
mu <- link( m8.1, post = prior, data = data.frame(rugged_std = rugged_seq))
for( i in 1:50 ) lines( rugged_seq, mu[i,], col = col.alpha("black", 0.3))
```


現在可以看看給出的事後概率分佈：

```{r introBayes11-04, cache=TRUE}
precis( m8.1 )
```

所以其實這裏我們給出的斜率的事後均值是零。那麼地區地理狀況是否崎嶇，和GDP之間真的沒有關係了嗎？

### 加一個指示變量並不是一個好選擇


最常見的增加非洲大陸這個變量的方法就是加一個指示變量：


$$
\mu_i = \alpha + \beta(r_i - \bar{r}) + \gamma A_i
$$

其中，增加的變量 $A_i$ 就是一個是否是非洲大陸國家的指示變量 (indicator variable)。但是事實上，每次增加一個這樣的指示變量時，你需要增加一個先驗概率給它的回歸係數。如此一來，它的副作用之一是告訴模型，我們對於在非洲大陸的國家的GDP的平均值有跟多的不確定性 (what the prior will necessarily do is tell the model that $\mu_i$ for a nation in Africa is more uncertain, before seeing the data, than $\mu_i$ outside Africa)，這其實不是我們希望的額外假設，也沒有實際意義。

所以值得推薦的處理方法應該是使用索引變量 (index variable) 的方法使屬於非洲大陸或者之外的國家擁有不同的截距：

$$
\mu_i = \alpha_{\text{CID}[i]} + \beta(r_i - \bar{r})
$$

其中，$\text{CID}[i]$ 就是這個索引變量，它取1時，截距就是非洲大陸國家的截距，它取2時，截距就是非洲大陸意外國家的截距。在 R 裏面很容易製作這樣的索引變量：


```{r introBayes11-05, cache=TRUE}
# Make variable to index Africa (1) or otherwise (2)

dd$cid <- ifelse( dd$cont_africa == 1, 1, 2)
```

如此，就可以巧妙地避免了增加指示變量造成的額外先驗概率帶來的不確定性假設：


```{r introBayes11-06, cache=TRUE}
m8.2 <- quap(
  alist(
    log_gdp_std ~ dnorm(mu, sigma), 
    mu <- a[cid] + b * ( rugged_std - 0.215 ),
    a[cid] ~ dnorm( 1, 0.1 ), 
    b ~ dnorm( 0, 0.3 ), 
    sigma ~ dexp(1)
  ), data = dd
)
precis(m8.2, depth = 2)
compare(m8.1, m8.2)
```

可以看到，`a[1]` 是非洲大陸國家的事後截距均值。可以看到它明顯是低於非洲大陸意外國家的事後截距均值 `a[2]`。對兩者的事後比較估算可以給我們更加確定的結果：

```{r introBayes11-07, cache=TRUE}
post <- extract.samples(m8.2)
diff_a1_a2 <- post$a[, 1] - post$a[, 2]
PI(diff_a1_a2)
```

可見兩類國家的GDP截距差很穩定地低於0。


```{r introBayes11-fig03, cache=TRUE, fig.width=6, fig.height=5,  fig.cap="Including an indicator for African nations has no effect on the slope. Africa nations are shown in blue. Non African nations are shown in black. Regression means for each subset of nations are shown in corresponding colors, along with 97% intervals shown by shading.", fig.align='center'}

rugged.seq <- seq(from  = -0.1, to = 1.1, length.out = 30)
# compute mu over samplesm fixing cid = 2 and then cid = 1
mu.NotAfrica <- link(m8.2, 
                     data = data.frame(cid = 2, rugged_std = rugged.seq))
mu.Africa <- link(m8.2, 
                  data = data.frame(cid = 1, rugged_std = rugged.seq))

# summarize to means and intervals
mu.NotAfrica_mu <- apply( mu.NotAfrica, 2, mean )
mu.NotAfrica_ci <- apply( mu.NotAfrica, 2, PI, prob = 0.97)
mu.Africa_mu <- apply( mu.Africa, 2, mean )
mu.Africa_ci <- apply( mu.Africa, 2, PI, prob = 0.97)

with(dd, plot(rugged_std[cid == 2], log_gdp_std[cid == 2], col=c("black"),
                    xlim = c(-0.05, 1.05), ylim = c(0.7, 1.3), 
                    bty  = "n", 
                    main = "m8.4",
                    xlab = "ruggedness (standardized)", 
                    ylab = "log GDP (as proportion of mean)"))
with(dd, points(rugged_std[cid == 1], 
       log_gdp_std[cid == 1], 
       col = rangi2, 
       pch = 16))
lines(rugged.seq, mu.NotAfrica_mu, lwd = 2)
lines(rugged.seq, mu.Africa_mu, lwd = 2, col = rangi2)
shade(mu.NotAfrica_ci, rugged.seq)
shade(mu.Africa_ci, rugged.seq, col = col.alpha(rangi2, 0.4))
text(0.9, 1.05, "Not Africa")
text(0.85, 0.9, "Africa", col = rangi2)
```

### 增加交互作用項是有幫助的

使用了索引變量的方法之後，我們發現加交互作用項，且避免增加冗餘的回歸係數的方法變得十分簡單：


$$
\mu_i = \alpha_{\text{CID}[i]} + \beta_{\text{CID}[i]}(r_i- \bar{r}) 
$$

```{r introBayes11-08, cache=TRUE}
m8.3 <- quap(
  alist(
    log_gdp_std ~ dnorm(mu, sigma), 
    mu <- a[cid] + b[cid] * ( rugged_std - 0.215 ),
    a[cid] ~ dnorm( 1, 0.1 ), 
    b[cid] ~ dnorm( 0, 0.3 ), 
    sigma ~ dexp(1)
  ), data = dd
)
precis(m8.3, depth = 2)
```

此時我們發現除了截距在非洲與非洲之外國家之間並不相同，他們和地區GDP之間的關係的斜率竟然也是相反的。比較這三個模型的模型指標：


```{r introBayes11-09, cache=TRUE}
compare( m8.1, m8.2, m8.3 )
```

### 繪製交叉作用

- 非洲國家的GDP和其地理崎嶇程度之間的關係圖：

```{r introBayes11-fig04, cache=TRUE, fig.width=6, fig.height=5,  fig.cap="Posterior predictitions for the terrain ruggedness model, including the interaction between Africa and ruggedness. Shaded regions are 97% posterior intervals of the mean. (Countries within Africa)", fig.align='center'}
# Plot Africa - cid = 1
d.A1 <- dd[dd$cid == 1,]
plot(d.A1$rugged_std, d.A1$log_gdp_std, pch = 16, 
     col = rangi2, 
     main = "African nations",
     xlab = "ruggedness (standardized)", 
     ylab = "log GDP (as proportion of mean)", 
     xlim = c(0,1))
mu <- link( m8.3, data = data.frame( cid = 1, rugged_std = rugged_seq))
mu_mean <- apply( mu, 2, mean )
mu_ci <- apply( mu, 2, PI, prob = 0.97)
lines( rugged_seq, mu_mean, lwd = 2)
shade(mu_ci, rugged_seq, col = col.alpha(rangi2, 0.3))
```

- 非洲大陸意外國家的GDP和其地理崎嶇程度之間的關係圖：

```{r introBayes11-fig05, cache=TRUE, fig.width=6, fig.height=5,  fig.cap="Posterior predictitions for the terrain ruggedness model, including the interaction between Africa and ruggedness. Shaded regions are 97% posterior intervals of the mean. (Countries outside of Africa)", fig.align='center'}
# plot non-Africa - cid = 2

d.A2 <- dd[dd$cid == 2,]
plot(d.A2$rugged_std, d.A2$log_gdp_std, pch = 1, 
     col = "black", 
     main = "Non-African nations",
     xlab = "ruggedness (standardized)", 
     ylab = "log GDP (as proportion of mean)", 
     xlim = c(0,1))
mu <- link( m8.3, data = data.frame( cid = 2, rugged_std = rugged_seq))
mu_mean <- apply( mu, 2, mean )
mu_ci <- apply( mu, 2, PI, prob = 0.97)
lines( rugged_seq, mu_mean, lwd = 2)
shade(mu_ci, rugged_seq)
```


## 

