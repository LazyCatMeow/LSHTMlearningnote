## 本章概要

- 學會寫下 Cox 比例風險方程的數學表達式
- 能夠解釋 Cox 比例風險模型是怎樣通過偏似然的方法獲取 MLE 的，他們又是怎樣獲得估計風險度比 (hazard ratio)，和它的標準誤，p 值，以及信賴區間的
- 比較 Cox 比例風險模型和全參數模型 (fully parametric models)，及非參數方法 (non-parametric methods)
- 能夠解釋各種不同類型的（連續型，二進制型，或者多變量型）解釋（暴露）變量在 Cox 比例風險模型中獲得的參數估計的涵義
- 學會使用統計軟件繪製的圖形方法來分析並解釋比例風險度的假設條件是否得到滿足
- 能夠在 R 等統計包中準確地運行需要的 Cox 比例風險模型，並且會用這些統計包輔助進行模型性能評測

## 初步介紹 Cox 比例風險模型

如果可以認爲暴露（解釋）變量對風險度的作用是成比例的 (act proportionally on the hazard)，那麼對某個觀察對象來說，他/她/它的解釋變量如果用向量 $\mathbf{X} = x$ 來表示的話，他/她/它的風險度方程和基線風險度 (baseline hazard) 之間的關係可以描述爲：

$$
h(t|x) = h_0(t)e^{\beta^Tx}
$$

其中，$h_0(t)$ 就是被比較的基線組成員(baseline individual)的風險度函數 (hazard function)，在 Weibull 模型或者指數模型中，這個基線風險 (baseline hazard) 是需要被模型根據數據來進行參數估計的 (parameterized)。但是，1972年，神一樣的人物 Cox [@Cox1972b] 提出，其實我們不需要對這個基線風險進行估計，可以忽略它在模型中的存在。正因為如此，這個模型被冠以發明者的名字 Cox proportional hazards model。因為此模型不對基線風險進行任何估計，但是對預測變量對於風險的效果 (effect of the explanatory variable) 用模型中的 $\beta$ 進行參數估計，所以，它又被稱爲是半參數化模型 (semi-parametric model)。

下面的討論，我們保持和之前的章節使用相同的數學標記法。

- $i = 1, \dots, n$ 標記實驗對象的個體編號
- $x_i$ 表示她/他/它的解釋型變量（大多數情況下它是包含了多個變量的向量）
- $t_i$ 表示生存時間（刪失時間）
- $\delta_i$ 則是指示是使用生存時間，或者刪失時間的指示變量 (indicator)

那麼用這些標記法描述的 Cox 比例風險模型下的似然是：

$$
L= \prod_{i=1}^n\{ h_0(t)e^{\beta^Tx_i}\exp(-\int_0^{t_i} h_0(u)e^{\beta^Tx_i}du) \}^{\delta_i}\{ \exp(-\int_0^{t_i} h_0(u)e^{\beta^Tx_i}du) \}^{1-\delta_i}
$$

是無法估計的，此時要用到偏似然法 (partial likelihood)，

## 偏似然法 (partial likelihood)

假定已知某一名實驗對象身上經過了生存時間 $t_j$ 之後發生了研究者追蹤的事件 (event of interest)。我們用 $i_j$ 標記該實驗對象，她/他/它身上具有的所有解釋變量則用 $x_{i_j}$ 來表達。在無限接近時間點 $t_j$ 之前的時刻，有一個包含了所有此時仍未發生事件的觀察對象的潛在對象集合 (risk set) $R_j$。觀察對象 $i_j$ 也屬於這個潛在對象集合 $R_j$。這裏我們假定該時間無限短，短到有且僅有一個對象可以發生事件，即沒有人同時發生事件。

接下來我們思考這樣一個問題：在這組用 $R_j$ 標記的潛在對象集合中，我們已知它們同時都存活到了時間點 $t_j$，且沒有發生刪失，那麼這組患者中的某個個體 $i_j$，它/他/她有一個解釋變量 $x_i$，它/他/她在這個時間點發生事件的條件概率 (conditional probability) 該怎麼計算？

$$
\frac{h_0(t_j)\exp(\beta^Tx_{i_j})}{\sum_{k\in R_j}h_0(t_j)\exp(\beta^Tx_k)} = \frac{\exp(\beta^Tx_{i_j})}{\sum_{k\in R_j}\exp(\beta^Tx_k)}
$$

是的，你沒有看錯，基線風險度 $h_0(t)$ 被完美的從分子和分母中抵消掉了，這就是它不需要被參數估計的原因。那麼，在所有發生事件的時間點上，我們都可以類似的計算其對應的條件概率，然後把所有發生事件時的條件概率相乘，就獲得了我們所需要的偏似然 (partial likelihood)，用 $L_p$ 來表示：

$$
L_p = \prod_j \frac{\exp(\beta^Tx_{i_j})}{\sum_{k\in R_j}\exp(\beta^Tx_k)}
$$

這個似然之所以被命名爲偏似然 (partial)，就因爲它並不是一個完整的生存過程，我們只巧妙地取用了生存過程中的一部分。而且目前爲止的統計學已經證明了，它和完整的標準似然在生存數據中其實是漸進一致的 (asymptotically the same)。這也就意味着，我們可以利用這個性質，忽略掉 $h_0(t)$，使用極大似然法來獲取全部的 $\beta$ 的估計值。且我們知道這些 MLE $\hat\beta$ 的方差 (variance) 可以通過計算 Fisher information matrix 的逆矩陣 (inverse of matrix) 來獲得。這樣我們就理解了 Cox 回歸的計算原理和過程。

該偏似然的對數如果用 $l_p$ 表示：

$$
l_p = \sum_j \beta^T x_{i_j} - \sum_j \log(\sum_{k \in R_j} \exp \beta^T x_k)
$$


在最簡單的只有一個解釋變量 $x$ 的情況之下，$\beta$ 可以通過對該對數似然求導數之後解下列的方程獲得：

$$
\frac{dl_p}{d\beta} = \sum_j x_{i_j} - \sum_j \frac{\sum_{k \in R_j} x_k \exp \beta x_k}{\sum_{k \in R_j} \exp \beta x_k} = 0
$$

如果 $\beta$ 是多個需要被估計的 MLE 那麼就會同時獲得多個類似上述方程的聯立方程需要同時求解。在實際操作中，統計包會選擇使用迭代法 (iterative method) 去尋找符合這樣聯立方程的解作爲 MLE。




```{example Survival-analysis-0401}
**給白血病患者數據套用 Cox 比例風險回歸模型** 在這個數據中，42名白血病患者中各有21人分別在治療和對照組。研究者關心的事件是病情的緩解 (remission)。追蹤時間是從白血病診斷時起，單位是週數。那麼暴露變量就是被分配到治療組與否，其中被分配到對照組的患者的風險度被認爲是基線風險度 (baseline hazard)。於是這個模型其實可以簡單描述成：

```



$$
\begin{cases}
     h_0(t)   & 對照組 \text{ control group} \\
     h_0(t) e^\beta & 治療組 \text{ treatment group}
\end{cases}
$$

使用偏似然法計算該模型的參數我們獲得對數風險度比 (log hazard ratio) 的估計值 $\hat\beta = -1.51$，其對應的標準誤是 $0.410$，95% 信賴區間是 (-2.31, -0.71)。於是相應的，風險度比 $\exp \hat\beta = 0.22$，95% 信賴區間是 $(0.10, 0.49)$。

該模型用 Stata 計算的過程如下

```{r engine='stata', echo=FALSE, eval=TRUE}
infile group weeks remission using https://data.princeton.edu/wws509/datasets/gehan.raw
label define group 1 "control" 2 "treated"
label values group group
stset weeks, failure(remission)
stcox group
stcox group, nohr
```


該模型用 R 計算的過程如下

```{r  Surv04-01, cache=TRUE}
gehan <- read.table("https://data.princeton.edu/wws509/datasets/gehan.raw", header =  FALSE, sep ="", col.names = c( "group", "weeks", "remission"))

cox.model <- coxph(Surv(time = weeks, event = remission) ~ as.factor(group), 
                     data = gehan, method = "breslow")
summary(cox.model)
```

### 爲什麼使用 Cox 回歸模型？

理由很簡單，半參數回歸模型我們放棄了對基線風險度的估計，也就是放寬了對它的限制和假設，使模型估計的結果更高效可靠 (efficient and reliable)。Cox回歸模型現在已經廣爲人知且易於理解。




模型的假設：

$$
h(t|x) = h_0(t)e^{\beta^Tx}
$$

1. Proportional hazards assumption - explanatory variables act **multiplicatively** on the hazard and their effect on the hazard does not change over time;
2. We have correctly specified the form for how continuous explanatory variables act on the hazard;
3. We have included all relevant explanatory variables including possbile interactions;
4. Uninformative censoring;
5. Individuals are independent.

## 該用半參數模型還是用全參數模型

- 如果說指數模型或者 Weibull 模型是合理的，通常此時用 Cox 半參數模型也是合理的；
- 如果指數模型或者 Weibull 模型都是合理的，那麼 Cox 半參數模型給出的估計，其實不會和指數模型或者 Weibull 模型相差甚遠。指數模型或者 Weibull 模型可能給出的估計會相對更精確 (更小的標準誤)，但是實際應用中這種更加精確的程度其實十分有限；
- 另外，使用指數模型或者 Weibull 模型，重要的基線風險是否被模型擬合正確將會是關鍵 (baseline hazard mis-specified?)，但是使用 Cox 模型，就可以避免這個假設，忽略掉基線風險；
- 2002 年，[@Royston2002] 提出第三種生存數據模型，"flexible parametric survival models"，結合了參數和半參數模型的長處，正在變得流行起來。在這個新型靈活參數生存模型中，使用了三次方程平滑曲線 (cubic splines modelled smoothly) 擬合對數基線累積風險 (log cumulative baseline hazard)。
